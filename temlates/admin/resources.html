{% extends "admin/base_admin.html" %}

{% block title %}Resources Management - SkillPath Admin{% endblock %}
{% block page_title %}Resources Management{% endblock %}
{% block breadcrumb %}Resources{% endblock %}

{% block admin_content %}
<div class="admin-resources">
    <!-- Header Section -->
    <div class="admin-page-header glass-card">
        <div class="header-content">
            <div class="header-text">
                <h1>Learning Resources</h1>
                <p>Manage and curate educational content for learning paths</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="openAddResourceModal()">
                    <i class="fas fa-plus"></i> Add Resource
                </button>
                <button class="btn btn-secondary" onclick="exportResources()">
                    <i class="fas fa-download"></i> Export
                </button>
            </div>
        </div>
        
        <div class="header-stats">
            <div class="stat-card glass-card">
                <div class="stat-icon primary">
                    <i class="fas fa-book"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-number" id="totalResources">{{ resources|length }}</span>
                    <span class="stat-label">Total Resources</span>
                </div>
            </div>
            <div class="stat-card glass-card">
                <div class="stat-icon success">
                    <i class="fas fa-link"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-number" id="resourcesWithUrls">{{ resources|selectattr('url')|list|length }}</span>
                    <span class="stat-label">With URLs</span>
                </div>
            </div>
            <div class="stat-card glass-card">
                <div class="stat-icon warning">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-number" id="courseResources">{{ resources|selectattr('type', 'equalto', 'course')|list|length }}</span>
                    <span class="stat-label">Courses</span>
                </div>
            </div>
            <div class="stat-card glass-card">
                <div class="stat-icon info">
                    <i class="fas fa-sync"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-number">87%</span>
                    <span class="stat-label">Usage Rate</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="filters-section glass-card">
        <div class="filters-row">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="resourceSearch" placeholder="Search resources...">
            </div>
            <div class="filter-group">
                <select id="typeFilter" class="filter-select">
                    <option value="">All Types</option>
                    <option value="course">Courses</option>
                    <option value="video">Videos</option>
                    <option value="article">Articles</option>
                    <option value="book">Books</option>
                    <option value="tutorial">Tutorials</option>
                    <option value="project">Projects</option>
                    <option value="documentation">Documentation</option>
                </select>
                <select id="categoryFilter" class="filter-select">
                    <option value="">All Categories</option>
                    <option value="web development">Web Development</option>
                    <option value="data science">Data Science</option>
                    <option value="ai">AI & ML</option>
                    <option value="design">Design</option>
                    <option value="mobile development">Mobile Development</option>
                    <option value="cybersecurity">Cybersecurity</option>
                    <option value="cloud computing">Cloud Computing</option>
                </select>
                <button class="btn btn-secondary" onclick="clearFilters()">
                    <i class="fas fa-times"></i> Clear
                </button>
            </div>
        </div>
    </div>

    <!-- Resources Table -->
    <div class="resources-table-container glass-card">
        <div class="table-header">
            <h3>Resource Library</h3>
            <div class="table-actions">
                <button class="btn btn-sm btn-secondary" onclick="selectAllResources()">
                    <i class="fas fa-check-square"></i> Select All
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteSelectedResources()">
                    <i class="fas fa-trash"></i> Delete Selected
                </button>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="resources-table">
                <thead>
                    <tr>
                        <th class="checkbox-column">
                            <input type="checkbox" id="selectAll">
                        </th>
                        <th class="title-column">Resource</th>
                        <th class="type-column">Type</th>
                        <th class="category-column">Category</th>
                        <th class="status-column">Status</th>
                        <th class="date-column">Created</th>
                        <th class="actions-column">Actions</th>
                    </tr>
                </thead>
                <tbody id="resourcesTableBody">
                    {% for resource in resources %}
                    <tr class="resource-row" data-resource-id="{{ resource.id }}" data-type="{{ resource.type }}" data-category="{{ resource.category or '' }}">
                        <td class="checkbox-column">
                            <input type="checkbox" class="resource-checkbox" value="{{ resource.id }}">
                        </td>
                        <td class="title-column">
                            <div class="resource-info">
                                <div class="resource-title">
                                    <strong>{{ resource.title }}</strong>
                                    {% if resource.description %}
                                    <p class="resource-desc">{{ resource.description[:120] }}{% if resource.description|length > 120 %}...{% endif %}</p>
                                    {% endif %}
                                </div>
                                {% if resource.url %}
                                <a href="{{ resource.url }}" target="_blank" class="resource-link">
                                    <i class="fas fa-external-link-alt"></i> Visit Resource
                                </a>
                                {% endif %}
                            </div>
                        </td>
                        <td class="type-column">
                            <span class="resource-type {{ resource.type }}">
                                <i class="fas fa-{{ get_resource_icon(resource.type) }}"></i>
                                {{ resource.type|title }}
                            </span>
                        </td>
                        <td class="category-column">
                            <span class="category-tag">{{ resource.category or 'Uncategorized' }}</span>
                        </td>
                        <td class="status-column">
                            <span class="status-badge active">Active</span>
                        </td>
                        <td class="date-column">
                            <div class="date-info">
                                <span class="date">{{ resource.created_at.strftime('%b %d, %Y') }}</span>
                                <span class="time">{{ resource.created_at.strftime('%I:%M %p') }}</span>
                            </div>
                        </td>
                        <td class="actions-column">
                            <div class="action-buttons">
                                <button class="btn btn-icon btn-sm btn-success" onclick="previewResource('{{ resource.id }}')" title="Preview">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-icon btn-sm btn-secondary" onclick="editResource('{{ resource.id }}')" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-icon btn-sm btn-danger" onclick="deleteResource('{{ resource.id }}')" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="table-footer">
            <div class="pagination-info">
                Showing <strong id="showingCount">{{ resources|length }}</strong> of <strong id="totalCount">{{ resources|length }}</strong> resources
            </div>
            <div class="pagination-controls">
                <button class="btn btn-sm btn-secondary" disabled>
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <span class="pagination-page">Page 1 of 1</span>
                <button class="btn btn-sm btn-secondary" disabled>
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Resource Modal -->
<div id="resourceModal" class="modal">
    <div class="modal-content glass-card large">
        <div class="modal-header">
            <h3 id="modalTitle">Add New Resource</h3>
            <button class="modal-close" onclick="closeResourceModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="resourceForm" class="modal-form">
            <input type="hidden" id="resourceId" name="id">
            
            <div class="form-section">
                <h4>Basic Information</h4>
                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="resourceTitle">Title *</label>
                        <input type="text" id="resourceTitle" name="title" required 
                               placeholder="Enter resource title...">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="resourceType">Type *</label>
                        <select id="resourceType" name="type" required>
                            <option value="">Select Type</option>
                            <option value="course">Online Course</option>
                            <option value="video">Video Tutorial</option>
                            <option value="article">Article/Blog Post</option>
                            <option value="book">E-book/Book</option>
                            <option value="tutorial">Interactive Tutorial</option>
                            <option value="project">Project Template</option>
                            <option value="documentation">Documentation</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="resourceCategory">Category</label>
                        <select id="resourceCategory" name="category">
                            <option value="">Select Category</option>
                            <option value="web development">Web Development</option>
                            <option value="mobile development">Mobile Development</option>
                            <option value="data science">Data Science</option>
                            <option value="ai">Artificial Intelligence</option>
                            <option value="machine learning">Machine Learning</option>
                            <option value="cybersecurity">Cybersecurity</option>
                            <option value="cloud computing">Cloud Computing</option>
                            <option value="ui/ux design">UI/UX Design</option>
                            <option value="devops">DevOps</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h4>Content Details</h4>
                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="resourceUrl">Resource URL</label>
                        <input type="url" id="resourceUrl" name="url" 
                               placeholder="https://example.com/resource">
                        <div class="form-hint">Link to the learning resource</div>
                    </div>
                </div>
                
                <div class="form-group full-width">
                    <label for="resourceDescription">Description</label>
                    <textarea id="resourceDescription" name="description" rows="4"
                              placeholder="Brief description of the resource, what users will learn, and why it's valuable..."></textarea>
                    <div class="form-hint">Provide a compelling description to help users understand the resource value</div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeResourceModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Resource
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Preview Modal -->
<div id="previewModal" class="modal">
    <div class="modal-content glass-card large">
        <div class="modal-header">
            <h3>Resource Preview</h3>
            <button class="modal-close" onclick="closePreviewModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="preview-content" id="previewContent">
            <!-- Preview content will be loaded here -->
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="loading-spinner" style="display: none;">
    <div class="spinner-content glass-card">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Loading...</p>
    </div>
</div>
{% endblock %}

{% block admin_scripts %}
<script>
// Global variables
let allResources = [];

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadResources();
    initializeEventListeners();
});

function initializeEventListeners() {
    // Search and filter functionality
    document.getElementById('resourceSearch').addEventListener('input', filterResources);
    document.getElementById('typeFilter').addEventListener('change', filterResources);
    document.getElementById('categoryFilter').addEventListener('change', filterResources);
    
    // Form submission
    document.getElementById('resourceForm').addEventListener('submit', handleFormSubmit);
}

function loadResources() {
    // In a real application, you might fetch resources via API
    // For now, we'll use the server-rendered data
    const rows = document.querySelectorAll('.resource-row');
    allResources = Array.from(rows).map(row => {
        return {
            id: row.dataset.resourceId,
            type: row.dataset.type,
            category: row.dataset.category,
            element: row
        };
    });
}

// Resource Management Functions
function openAddResourceModal() {
    document.getElementById('modalTitle').textContent = 'Add New Resource';
    document.getElementById('resourceForm').reset();
    document.getElementById('resourceId').value = '';
    document.getElementById('resourceModal').style.display = 'flex';
}

function closeResourceModal() {
    document.getElementById('resourceModal').style.display = 'none';
}

async function previewResource(resourceId) {
    showLoading();
    try {
        const response = await fetch(`/admin/resources/${resourceId}`);
        const data = await response.json();
        
        if (data.success) {
            const resource = data.resource;
            const previewContent = document.getElementById('previewContent');
            
            previewContent.innerHTML = `
                <div class="resource-preview">
                    <div class="preview-header">
                        <div class="preview-type">
                            <i class="fas fa-${getResourceIcon(resource.type)}"></i>
                            <span>${resource.type.charAt(0).toUpperCase() + resource.type.slice(1)}</span>
                        </div>
                        <div class="preview-meta">
                            <span class="category-badge">${resource.category || 'Uncategorized'}</span>
                        </div>
                    </div>
                    <h3 class="preview-title">${resource.title}</h3>
                    <p class="preview-description">${resource.description || 'No description provided.'}</p>
                    ${resource.url ? `
                    <div class="preview-url">
                        <i class="fas fa-link"></i>
                        <a href="${resource.url}" target="_blank">${resource.url}</a>
                    </div>
                    ` : ''}
                    <div class="preview-meta-info">
                        <div class="meta-item">
                            <strong>Created:</strong>
                            <span>${new Date(resource.created_at).toLocaleDateString()}</span>
                        </div>
                        <div class="meta-item">
                            <strong>ID:</strong>
                            <span>${resource.id}</span>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('previewModal').style.display = 'flex';
        } else {
            showAdminToast('Failed to load resource details', 'error');
        }
    } catch (error) {
        console.error('Error previewing resource:', error);
        showAdminToast('Error loading resource details', 'error');
    } finally {
        hideLoading();
    }
}

function closePreviewModal() {
    document.getElementById('previewModal').style.display = 'none';
}

async function editResource(resourceId) {
    showLoading();
    try {
        const response = await fetch(`/admin/resources/${resourceId}`);
        const data = await response.json();
        
        if (data.success) {
            const resource = data.resource;
            
            document.getElementById('modalTitle').textContent = 'Edit Resource';
            document.getElementById('resourceId').value = resource.id;
            document.getElementById('resourceTitle').value = resource.title;
            document.getElementById('resourceType').value = resource.type;
            document.getElementById('resourceCategory').value = resource.category || '';
            document.getElementById('resourceUrl').value = resource.url || '';
            document.getElementById('resourceDescription').value = resource.description || '';
            
            document.getElementById('resourceModal').style.display = 'flex';
        } else {
            showAdminToast('Failed to load resource for editing', 'error');
        }
    } catch (error) {
        console.error('Error editing resource:', error);
        showAdminToast('Error loading resource for editing', 'error');
    } finally {
        hideLoading();
    }
}

async function deleteResource(resourceId) {
    if (!confirm('Are you sure you want to delete this resource? This action cannot be undone.')) {
        return;
    }
    
    showLoading();
    try {
        const response = await fetch(`/admin/resources/${resourceId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAdminToast('Resource deleted successfully', 'success');
            // Remove the resource row from the table
            const row = document.querySelector(`[data-resource-id="${resourceId}"]`);
            if (row) {
                row.remove();
                updateResourceCounts();
            }
            // Reload the page to refresh the data
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showAdminToast(data.message || 'Failed to delete resource', 'error');
        }
    } catch (error) {
        console.error('Error deleting resource:', error);
        showAdminToast('Error deleting resource', 'error');
    } finally {
        hideLoading();
    }
}

async function handleFormSubmit(e) {
    e.preventDefault();
    
    const formData = {
        title: document.getElementById('resourceTitle').value,
        type: document.getElementById('resourceType').value,
        category: document.getElementById('resourceCategory').value,
        url: document.getElementById('resourceUrl').value,
        description: document.getElementById('resourceDescription').value
    };
    
    const resourceId = document.getElementById('resourceId').value;
    const isEdit = !!resourceId;
    
    showLoading();
    try {
        const url = isEdit ? `/admin/resources/${resourceId}` : '/admin/resources/add';
        const method = isEdit ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAdminToast(data.message, 'success');
            closeResourceModal();
            // Reload the page to show updated data
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showAdminToast(data.message || 'Operation failed', 'error');
        }
    } catch (error) {
        console.error('Error saving resource:', error);
        showAdminToast('Error saving resource', 'error');
    } finally {
        hideLoading();
    }
}

// Bulk Operations
function selectAllResources() {
    const checkboxes = document.querySelectorAll('.resource-checkbox');
    const selectAll = document.getElementById('selectAll');
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

async function deleteSelectedResources() {
    const selected = document.querySelectorAll('.resource-checkbox:checked');
    if (selected.length === 0) {
        showAdminToast('Please select at least one resource to delete', 'error');
        return;
    }
    
    if (!confirm(`Are you sure you want to delete ${selected.length} selected resources? This action cannot be undone.`)) {
        return;
    }
    
    const resourceIds = Array.from(selected).map(checkbox => checkbox.value);
    
    showLoading();
    try {
        const response = await fetch('/admin/resources/bulk_delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ resource_ids: resourceIds })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAdminToast(data.message, 'success');
            // Reload the page to refresh the data
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showAdminToast(data.message || 'Failed to delete resources', 'error');
        }
    } catch (error) {
        console.error('Error deleting resources:', error);
        showAdminToast('Error deleting resources', 'error');
    } finally {
        hideLoading();
    }
}

// Filtering and Search
function filterResources() {
    const searchTerm = document.getElementById('resourceSearch').value.toLowerCase();
    const typeFilter = document.getElementById('typeFilter').value;
    const categoryFilter = document.getElementById('categoryFilter').value;
    
    const rows = document.querySelectorAll('.resource-row');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const title = row.querySelector('.resource-title strong').textContent.toLowerCase();
        const description = row.querySelector('.resource-desc')?.textContent.toLowerCase() || '';
        const type = row.dataset.type;
        const category = (row.dataset.category || '').toLowerCase();
        
        const matchesSearch = title.includes(searchTerm) || description.includes(searchTerm);
        const matchesType = !typeFilter || type === typeFilter;
        const matchesCategory = !categoryFilter || category.includes(categoryFilter.toLowerCase());
        
        if (matchesSearch && matchesType && matchesCategory) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    updateShowingCount(visibleCount);
}

function clearFilters() {
    document.getElementById('resourceSearch').value = '';
    document.getElementById('typeFilter').value = '';
    document.getElementById('categoryFilter').value = '';
    filterResources();
    showAdminToast('Filters cleared', 'info');
}

// Utility Functions
function getResourceIcon(type) {
    const icons = {
        'course': 'graduation-cap',
        'video': 'video',
        'article': 'newspaper',
        'book': 'book',
        'tutorial': 'laptop-code',
        'project': 'project-diagram',
        'documentation': 'file-alt'
    };
    return icons[type] || 'link';
}

function updateResourceCounts() {
    const totalResources = document.querySelectorAll('.resource-row').length;
    const resourcesWithUrls = document.querySelectorAll('.resource-link').length;
    const courseResources = document.querySelectorAll('[data-type="course"]').length;
    
    document.getElementById('totalResources').textContent = totalResources;
    document.getElementById('resourcesWithUrls').textContent = resourcesWithUrls;
    document.getElementById('courseResources').textContent = courseResources;
}

function updateShowingCount(count) {
    document.getElementById('showingCount').textContent = count;
}

function showLoading() {
    document.getElementById('loadingSpinner').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('loadingSpinner').style.display = 'none';
}

function exportResources() {
    showAdminToast('Exporting resources...', 'info');
    // In a real implementation, this would generate and download a CSV/Excel file
    setTimeout(() => {
        showAdminToast('Resources exported successfully!', 'success');
    }, 2000);
}

// Close modals when clicking outside
window.onclick = function(event) {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });
}

// Toast notification function
function showAdminToast(message, type = 'info') {
    let container = document.getElementById('admin-toast-container');
    if (!container) {
        container = document.createElement('div');
        container.id = 'admin-toast-container';
        container.style.cssText = `
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        `;
        document.body.appendChild(container);
    }
    
    const toast = document.createElement('div');
    toast.className = `admin-toast toast-${type}`;
    toast.innerHTML = `
        <div class="toast-content">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
            <span>${message}</span>
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    container.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 5000);
}
</script>

<style>
.loading-spinner {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
}

.spinner-content {
    padding: 2rem;
    text-align: center;
    min-width: 200px;
}

.spinner-content i {
    font-size: 2rem;
    margin-bottom: 1rem;
    color: var(--primary-color);
}

.category-badge {
    padding: 0.25rem 0.75rem;
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    font-size: 0.8rem;
    color: var(--text-secondary);
}

.preview-meta-info {
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 1px solid var(--glass-border);
}

.meta-item {
    display: flex;
    justify-content: between;
    margin-bottom: 0.5rem;
}

.meta-item strong {
    min-width: 80px;
    color: var(--text-secondary);
}
</style>
{% endblock %}
